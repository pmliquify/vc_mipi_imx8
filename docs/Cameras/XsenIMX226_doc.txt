XsenIMX226 Command Interface V0
===============================

1. Mipi Module Command Interface

The Mipi Module command interface controls the Mipi Module's operation.
It uses the I2C interface (signals I2C_SCL and I2C_SDA) for communication.
Two separate I2C addresses are used to communicate with the module
controller and the sensor.

    default module controller I2C address:  0x10
    default sensor I2C address:             0x1A

1.1 Basic Communication Protocol

Communication protocol message type in short:

7bit slave address, 16bit sub-address, 8bit data


S | slave address[6:0] | r/w | A | subaddress[15:8] | A | subaddress[7:0] | data[7:0] | A/nA | P

S: start
P: stop
r/w: 1 for read operation
A: acknowledge
nA: negative acknowledge

The following operations are supported:

* single and sequential reads from random location
* single and sequential reads from current location
* single and sequential writes starting at random location

The internal subaddress automatically inreases by one after each read or write operation.

When the "single read from random location" is desired, the master must issue
a dummy write operation with only the subaddress. The master can then issue a stop and a new
start for the next access or alternatively a repeated start condition.
The module is addressed again with its I2C address for the read operation.
It is not allowed to change I2C addresses within a sequential READ/WRITE-operation.


2. Module Controller Registers

default module controller I2C address:  0x10

The module controller has 16 registers and a hardware descriptor ROM which is accessible via I2C.
The registers are either read/write (R/W) or read-only (R).
Registers start with 16-bit address 0x0100, i.e. register 1 has address 0x0101


register 0 [0x0100]: reset and init register (R/W)

reg0[0] = 0 sensor reset	the sensor is held in reset when this bit is 1
reg0[1] = 0 power down		power for the sensor is switched off

Both operations will completely reset the sensor (but not the module controller)
to its default state. No communication with sensor is possible in this state.
As soon as reg0[1:0] is zero, the module controller will perform an initialization
sequence, i.e according to the value in register 2 the sensor will pe programmed
to the respective cs. A successful initialization sequence will be indicated
by a value of 0x80 in register 1. 
This also indicates that communication with the sensor is possible.


register 1 [0x0101]: status (R) 

reg1[7:0] = 0x00 default, no communication with sensor possible
reg1[7:0] = 0x80 sensor ready after successful initialization sequence
reg1[7:0] = 0x01 internal error during initialization

remark: automatic clear of this register on powerdown or reset (reg0)


register 2 [0x0102]: initialisation mode (R/W)

reg2[7:0] = 0x00 :  8bit, 2 lanes, streaming
reg2[7:0] = 0x01 : 10bit, 2 lanes, streaming
reg2[7:0] = 0x02 : 12bit, 2 lanes, streaming
reg2[7:0] = 0x03 :  8bit, 2 lanes, external trigger global shutter reset 
reg2[7:0] = 0x04 : 10bit, 2 lanes, external trigger global shutter reset
reg2[7:0] = 0x05 : 12bit, 2 lanes, external trigger global shutter reset
reg2[7:0] = 0x06 :  8bit, 4 lanes, streaming
reg2[7:0] = 0x07 : 10bit, 4 lanes, streaming
reg2[7:0] = 0x08 : 12bit, 4 lanes, streaming
reg2[7:0] = 0x09 :  8bit, 4 lanes, external trigger global shutter reset
reg2[7:0] = 0x0A : 10bit, 4 lanes, external trigger global shutter reset
reg2[7:0] = 0x0B : 12bit, 4 lanes, external trigger global shutter reset

reg2[7:0] = 0x00 per default

Set the value for the desired mode first, then change register 0 (reset or power down).
When register 0 is set to 0 again, the initialization with the desired mode is performed.

remark: 22_22 cable required for 4-lane modes

register 3 [0x0103]: input/output control (R/W)

reg3[0] : enable flash output
reg3[1] : enable fs output (on trigger signal), not used for IMX226
reg3[2] : exchange trigger and flash signals
reg3[3] : enable xtrig sensor signal, default = 1, not used for IMX226
reg3[4] : polarity flash output
reg3[5] : polarity fs output, not used for IMX226
reg3[6] : polarity trigger input signal

reg3[7:0] = 0x08 per default

The mipi module has two external I/O signals on its connector
called "flash_from_sensor" (short: "flash") and "trigger_to_sensor" (short: "trigger").

Although their names suggest a configuration where "flash" is always an output and
"trigger" is always in input, both signals are in fact bidirectional and can be
used in a very flexible way.

Per default, flash and trigger signals are configured as inputs, 
preventing a short-circuit if the pin is driven by the CPU board. 


If the signals need to be used as intended, flash must be set as output,
resulting in a value of reg3[7:0] = 0x09.
It is possible to invert the polarity (which is "active high" per default).
It is also possible to exchange the role of flash and trigger, i.e. the flash output
would be using the signal "trigger_to_sensor" and the trigger input would be on 
signal "flash_from_sensor". In this case the value would be reg3[7:0] = 0x0E. 


register 4 [0x0104]: module i2c address (R/W, default: 0x10)


register 5 [0x0105]: sensor i2c address (R/W, default: 0x1A)


register 6 [0x0106]: output signal override register (R/W, default: 0x00)

reg6[0] : new value for signal "flash" 
reg6[1] : new value for signal "trigger"

reg6[4] : override value for signal "flash"
reg6[5] : override value for signal "trigger"

It may be desirable to use one or both signals as a general purpose output.
In this case, the corresponding signal must be configured as an output
with register 3. In register 6, the corresponding override bit must be set.
Changing reg6[0] will then be reflected on the "flash" output,
changing reg6[1] will be reflected on the "trigger" signal.


register 7 [0x0107]: input signal status register (R)

reg7[0] : value of signal "flash" 
reg7[1] : value of signal "trigger"

It is also convenient to have a register that reflects the status of
both IO-lines "flash" and "trigger".
It does not matter if the IO-lines are configured as inputs or as outputs.
register 7 will always reflect the state of the corresponding pin.


register 8 [0x0108]: external trigger enable (R/W, default: 0x00)

To enable the external trigger, one of the register bits must be set to 1

reg8[0] : 1 for external trigger enable using internal exposure timer
reg8[1] :   not available for IMX226
reg8[2] : 1 for self-trigger feature (like streaming mode)
            This feature uses the retrigger register (reg13-16)
            to emulate a self-triggered mode that looks like
            the native streaming mode but with nanosecond accurate
            shutter speed setting and flash trigger output.
	    The external trigger hardware signal is disabled in
            this mode.
reg8[3] :   single trigger, set this bit to 1 for software-controlled
	    'external' trigger. The bit automatically resets itself.

reg8 = 0x00 prevents the acquisition of externally triggered images
before the software driver is ready to accept them.
It is only allowed to set one of the above bits. All other bit
combinations will be ignored.

register 8 is cleared on sensor reset or power down (register 0).


register 9  [0x0109]: exposure LSB (R/W, default: 0x10)
register 10 [0x010A]: exposure 	   (R/W, default: 0x27)
register 11 [0x010B]: exposure     (R/W, default: 0x00)
register 12 [0x010C]: exposure MSB (R/W, default: 0x00)

This is the 32bit register (4 x 8bit) for the exposure control when
using the fast trigger mode.
The exposure counter is using the internal 72MHz clock, i.e.
the exact exposure value is calculated as follows:

   exposure_time [nsec] = exposure_register[31:0] * 13.8889nsec


register 13 [0x010D]: retrigger LSB (R/W, default: 0x40)
register 14 [0x010E]: retrigger     (R/W, default: 0x2D)
register 15 [0x010F]: retrigger     (R/W, default: 0x29)
register 16 [0x0110]: retrigger MSB (R/W, default: 0x00)

With this 32bit register it is possible to prevent a re-triggering
of the sensor when it is busy acquiring an image.
The default setting is chosen to allow for a 60.3fps triggering
of full frames. It is not allowed to re-trigger the sensor
when it is busy. When changing the value of this register
make sure to operate the sensor in the allowed safe timeframe
for the trigger.
It is no problem to set values greater than those allowed.
The retrigger timer is active for all trigger modes.

The retrigger timer is using the internal 72MHz clock, i.e.
the exact retrigger time is calculated as follows:

   retrigger_time [nsec] = exposure_register[31:0] * 13.8889nsec


 
3. Hardware Desriptor ROM [0x1000]

Starting at subaddress 0x1000, the module controller features a
hardware descriptor ROM, describing some of the hardware properties
of the module and the sensor.
It should be possible to use this information to make the driver software
"generic" for a certain class of modules or sensors, i.e. the driver
software can load this information and switch to an operating mode
that can handle and interface to the particular module.

However, for example comparing Omnivision with Sony sensors, it soon
becomes clear that it will not be possible to support all features
for all sensors with a single driver.


3.1 Content of the Descriptor ROM


# IMX226 descriptor ROM
#
#
0000:6d 69 70 69    # magic number          = "mipi-module" 
0004:2d 6d 6f 64 
0008:75 6c 65 00
#
000C:56 69 73 69    # manufacturer string   = "Vision Components"
0010:6f 6e 20 43
0014:6f 6d 70 6f
0018:6e 65 6e 74 
001C:73 00 00 00
0020:00 00 00 00
0024:00 00 00 00
0028:00 00 00 00
#
#
002C:27 04          # Mipi Manufacturer ID (MID) = 0x0427
#
002E:53 4F 4E 59    # sensor manufacturer   = "SONY"
0032:00 00 00 00
#
0036:49 4D 58 32    # sensor type           = "IMX226"
003A:32 36 00 00
003E:00 00 00 00
0042:00 00 00 00
#
0046:26 02          # module ID             = 0x0226
0048:01 00          # module revision       = 0x0001
#
# sensor registers:
004A:0B 70          # chip ID high byte     = 0x700B	value = 0x02
004C:0A 70          # chip ID low byte      = 0x700A  	value = 0x26 
004E:0C 70          # chip revision         = 0x700C	value = 0x00
#
0050:00 70          # idle                  = 0x7000
0052:14 60          # horizontal start high = 0x6014
0054:13 60          # horizontal start low  = 0x6013 
0056:0F 60          # vertical start high   = 0x600F
0058:0E 60          # vertical start low    = 0x600E
005A:00 00          # horizontal end H      = 0x0000
005C:00 00          # horizontal end L      = 0x0000
005E:00 00          # vertical   end H      = 0x0000
0060:00 00          # vertical   end L      = 0x0000
0062:16 60          # hor. output width H   = 0x6016
0064:15 60          # hor. output width L   = 0x6015
0066:11 60          # ver. output height H  = 0x6011
0068:10 60          # ver. output height L  = 0x6010
006A:00 00          # exposure H            = 0x0000
006C:0C 00          # exposure M            = 0x000C
006E:0B 00          # exposure L            = 0x000B   
0070:0A 00          # gain high             = 0x000A   
0072:09 00          # gain low              = 0x0009   
#
#  
0074:00 00    		# reserved
0076:00 00 00 00
007A:00 00 00 00
007E:00 00 00 00
#
0082:0C 00          # number of modes (12)
0084:10 00          # number of bytes per mode = 16
#
0086:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
008A:02             # number of mipi lanes  = 2  
008B:2A             # mipi format           = RAW08
008C:01             # type                  = streaming
008D:00             # reserved
008E:00 00 00 00
0092:00 00 00 00
#
0096:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
009A:02             # number of mipi lanes  = 2  
009B:2B             # mipi format           = RAW10
009C:01             # type                  = streaming
009D:00             # reserved
009E:00 00 00 00
00A2:00 00 00 00
#
00A6:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
00AA:02             # number of mipi lanes  = 2  
00AB:2C             # mipi format           = RAW12
00AC:01             # type                  = streaming
00AD:00             # reserved
00AE:00 00 00 00
00B2:00 00 00 00
#
00B6:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
00BA:02             # number of mipi lanes  = 2  
00BB:2A             # mipi format           = RAW08
00BC:02             # type                  = external trigger
00BD:00             # reserved
00BE:00 00 00 00
00C2:00 00 00 00
#
00C6:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
00CA:02             # number of mipi lanes  = 2  
00CB:2B             # mipi format           = RAW10
00CC:02             # type                  = external trigger
00CD:00             # reserved
00CE:00 00 00 00
00D2:00 00 00 00
#
00D6:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
00DA:02             # number of mipi lanes  = 2  
00DB:2C             # mipi format           = RAW12
00DC:02             # type                  = external trigger
00DD:00             # reserved
00DE:00 00 00 00
00E2:00 00 00 00
#
00E6:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
00EA:04             # number of mipi lanes  = 4  
00EB:2A             # mipi format           = RAW08
00EC:01             # type                  = streaming
00ED:00             # reserved
00EE:00 00 00 00
00F2:00 00 00 00
#
00F6:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
00FA:04             # number of mipi lanes  = 4  
00FB:2B             # mipi format           = RAW10
00FC:01             # type                  = streaming
00FD:00             # reserved
00FE:00 00 00 00
0102:00 00 00 00
#
0106:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
010A:04             # number of mipi lanes  = 4  
010B:2C             # mipi format           = RAW12
010C:01             # type                  = streaming
010D:00             # reserved
010E:00 00 00 00
0112:00 00 00 00
#
0116:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
011A:04             # number of mipi lanes  = 4  
011B:2A             # mipi format           = RAW08
011C:02             # type                  = external trigger
011D:00             # reserved
011E:00 00 00 00
0122:00 00 00 00
#
0126:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
012A:04             # number of mipi lanes  = 4  
012B:2B             # mipi format           = RAW10
012C:02             # type                  = external trigger
012D:00             # reserved
012E:00 00 00 00
0132:00 00 00 00
#
0136:00 2F 68 59    # mipi data rate        = 1500 MBit/sec
013A:04             # number of mipi lanes  = 4  
013B:2C             # mipi format           = RAW12
013C:02             # type                  = external trigger
013D:00             # reserved
013E:00 00 00 00
0142:00 00 00 00
#

remarks:
"external trigger" mode always uses global shutter reset and should be using
a strobed flash illumination. 

3.1.1 magic number

This magic number can be used to detect that a module is present.
It will always be the same for all of the mipi modules.

3.1.2 sensor manufacturer

This field can be "OM" for Omnivision "SONY" for Sony or "ON SEMI"
for ON Semiconductor (former Aptina, Kodak, etc. sensors)
It is recommended to use the information in this field to define
a certain class of sensors.
Remark: It could be necessary to subdivide, for instance, the 
Sony sensors further into "Pregius" and "starvis" to define
a consistent class of sensors with similar behavior.

3.1.3 module ID

This is a unique module ID

3.1.4 sensor registers

Here we have a list of all sensor registers that are accessible
to modify parameters and to change performance.

The sensor registers in this list are all Read/Write.
The user could procede as follows:

(1) read out the descriptor ROM and make a copy for the host system.

(2) initialize the sensor and the module using the procedure described above.

(3) read out the sensor registers in this list to get the information
    about the specific mode setting.
    E.g. the "horizontal output width" register value can be used 
    to extract the maximum horizotal width for the particular 
    mode chosen.
    Each mode will always initialize the maximum allowed 
    horizontal width and vertical height.


3.1.5 Mode Descriptors

This is a list of descriptors, one for each mode. For properly decoding
the list, we have the number of different modes and the size of the
descriptors.

For the mipi format we use mipi alliance format specifiers.
For the type we have:

1 : streaming mode
2 : external trigger mode



remarks: 
(1) External triggering works up to a frequency of about ??? Hz for
    the IMX226's minimal exposure time.

(2) When using 4 lanes, a 22_22 flat cable is required.
    The 15_22 cable supports 2 lanes only.

(3) The delay between the trigger input and the start of the image 
    acquisition is ???15µsec???. This is due to the debouncing hardware
    on the module and the requirements of the global reset shutter timing.

(4) The sensor issues very reliable flash pulses in external trigger mode.
    The flash pulses exactly represent the time when the
    exposure takes place.
    Due to the nature of the global reset shutter, parts of the image
    will have longer exposure time depending on the vertical position.

(5) If flash pulses are necessary with some kind of streaming mode, we 
    recommend the following:
    (a) set the sensor into external trigger mode
    (b) set reg8[2] = 1 for auto-self-trigger feature
    (c) set exposure time using registers 9-12
    (d) set frame rate using registers 13-16
        please note that the frame period will be the sum
        of the exposure timer registers 9-12 and the
        retrigger registers 13-16


(6) Lifetime Specification

Currently we do not know about a lifetime specification from Sony for
this sensor.



 